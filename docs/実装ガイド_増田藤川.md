# 実装ガイド - 増田さん・藤川さん

**作成日**: 2025年10月30日
**対象**: 増田さん（睡眠管理）・藤川さん（タスク管理）
**目的**: Week 3-4のコア機能実装をスムーズに開始するための手順書

---

## 📦 作成済みファイル一覧

すべてのファイルは実装済みで、詳細なコメントとTODOが記載されています。

### 共通ファイル（両者で使用）

| ファイル | 内容 | 状態 |
|---------|------|------|
| [src/utils/dateFormatter.ts](../src/utils/dateFormatter.ts) | 日付・時刻の変換関数 | ✅ 完成 |
| [src/services/database.ts](../src/services/database.ts) | SQLite CRUD操作 | ✅ 完成 |
| [App.tsx](../App.tsx) | データベース初期化追加済み | ✅ 完成 |

### 増田さん担当ファイル

| ファイル | 内容 | 状態 |
|---------|------|------|
| [src/services/sleepScoreCalculator.ts](../src/services/sleepScoreCalculator.ts) | 睡眠スコア計算ロジック | ✅ 完成 |
| [src/services/adviceGenerator.ts](../src/services/adviceGenerator.ts) | AIアドバイス生成 | ✅ 完成 |
| [src/screens/SleepTrackerScreen.tsx](../src/screens/SleepTrackerScreen.tsx) | 睡眠記録画面 | ✅ 完成 |

### 藤川さん担当ファイル

| ファイル | 内容 | 状態 |
|---------|------|------|
| [src/components/EmotionPicker.tsx](../src/components/EmotionPicker.tsx) | 感情選択モーダル | ✅ 完成 |
| [src/screens/TaskJournalScreen.tsx](../src/screens/TaskJournalScreen.tsx) | タスク管理画面 | ✅ 完成 |

---

## 🚀 セットアップ手順（初回のみ）

### 1. 依存関係のインストール確認

```bash
# プロジェクトディレクトリに移動
cd /Users/matsulab/GitHub/Mindful_Rhythm

# 依存関係がインストール済みか確認
npm list @react-native-community/datetimepicker

# もしインストールされていない場合
npm install @react-native-community/datetimepicker --legacy-peer-deps
```

### 2. アプリの起動確認

```bash
# Expoサーバーを起動
npm start

# または
npx expo start
```

起動後、以下のいずれかの方法で動作確認：
- **Expo Go アプリ**: スマホでQRコードをスキャン
- **iOSシミュレータ**: `i`キーを押す
- **Androidエミュレータ**: `a`キーを押す
- **Webブラウザ**: `w`キーを押す

### 3. 動作確認項目

✅ **アプリが起動する**
✅ **ホーム画面が表示される**（スリーピンと82点表示）
✅ **タブナビゲーションが動作する**（5タブ切り替え可能）
✅ **コンソールに "✅ App initialized with database" が表示される**

---

## 👨‍💻 増田さん: 睡眠管理機能の実装

### Week 3（今週）のタスク

#### タスク1: 睡眠記録画面の動作確認 ⭐️最優先

**ファイル**: [src/screens/SleepTrackerScreen.tsx](../src/screens/SleepTrackerScreen.tsx)

**確認手順**:
1. アプリを起動
2. 「😴 睡眠記録」タブをタップ
3. 以下の入力フォームが表示されることを確認:
   - 就寝時間選択（デフォルト22:00）
   - 起床時間選択（デフォルト07:00）
   - 睡眠の質（3択ボタン）
   - 中途覚醒回数（数字入力）
   - 入眠潜時（数字入力）
   - 環境タグ（8種類のタグボタン）
   - 「記録を保存」ボタン

**テスト手順**:
```
1. 就寝時間: 22:30 に設定
2. 起床時間: 07:00 に設定
3. 睡眠の質: 「よく眠れた」を選択
4. 中途覚醒回数: 1回
5. 入眠潜時: 15分
6. 環境タグ: 「運動」「入浴」「カフェインなし」を選択
7. 「記録を保存」ボタンをタップ

→ 「睡眠スコア: XX点 記録を保存しました！」のアラートが表示されればOK
```

**デバッグ方法**:
```typescript
// コンソールログで確認
// SleepTrackerScreen.tsx の handleSave 関数内
console.log('✅ Sleep record saved:', scoreResult);

// → 以下のような出力が表示されるはず
// {
//   totalScore: 87,
//   breakdown: { ... },
//   totalHours: 8.5
// }
```

---

#### タスク2: ホーム画面とデータベースの連携

**ファイル**: [src/screens/HomeScreen.tsx](../src/screens/HomeScreen.tsx)

**現在の状態**:
```typescript
const sleepScore = 82; // ← モックデータ（固定値）
```

**TODO（増田さんが実装）**:
```typescript
import { useEffect, useState } from 'react';
import { getSleepRecord } from '../services/database';
import { getToday } from '../utils/dateFormatter';

export default function HomeScreen({ navigation }: Props) {
  // モック値を削除
  // const sleepScore = 82;

  // データベースから取得
  const [sleepScore, setSleepScore] = useState<number | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    loadTodayScore();
  }, []);

  const loadTodayScore = async () => {
    try {
      const today = getToday();
      const record = await getSleepRecord(today);
      setSleepScore(record?.score ?? null);
      console.log('✅ Today sleep score:', record?.score);
    } catch (error) {
      console.error('❌ Error loading sleep score:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // スコア表示部分を修正
  {isLoading ? (
    <Text style={styles.scoreValue}>--</Text>
  ) : sleepScore !== null ? (
    <Text style={styles.scoreValue}>{sleepScore}</Text>
  ) : (
    <Text style={styles.noDataText}>未記録</Text>
  )}
}
```

**動作確認**:
1. 睡眠記録画面で記録を保存
2. ホーム画面に戻る
3. 保存したスコアが表示されることを確認

---

#### タスク3: 睡眠スコア計算ロジックのテスト

**ファイル**: [src/services/sleepScoreCalculator.ts](../src/services/sleepScoreCalculator.ts)

**テストコード作成**（オプション）:
```typescript
// __tests__/sleepScoreCalculator.test.ts
import { calculateSleepScore } from '../src/services/sleepScoreCalculator';

test('良い睡眠のスコア計算', () => {
  const result = calculateSleepScore({
    bedtime: '22:30',
    waketime: '07:00',
    sleep_quality: 'よく眠れた',
    awakenings: 0,
    sleep_latency: 10,
    tags: ['運動', '入浴', 'カフェインなし', '室温適正'],
  });

  expect(result.totalScore).toBeGreaterThan(85); // 85点以上
  expect(result.totalHours).toBeCloseTo(8.5);
});
```

**手動テスト**:
| ケース | 期待スコア | 実測スコア |
|--------|-----------|-----------|
| 完璧な睡眠（7h, よく眠れた, 覚醒0, 潜時10分, タグ4つ） | 95～100点 | ? |
| 普通の睡眠（7h, 普通, 覚醒1, 潜時15分, タグ2つ） | 75～85点 | ? |
| 悪い睡眠（5h, 浅かった, 覚醒3, 潜時30分, タグ0） | 40～55点 | ? |

---

### Week 4のタスク（予定）

- [ ] 睡眠日記画面実装（SleepDiaryScreen.tsx作成）
- [ ] AIアドバイス表示機能（ホーム画面に追加）
- [ ] 睡眠改善課題の自動提示（ホーム画面に追加）

---

## 👩‍💻 藤川さん: タスク管理機能の実装

### Week 3（今週）のタスク

#### タスク1: タスク管理画面の動作確認 ⭐️最優先

**ファイル**: [src/screens/TaskJournalScreen.tsx](../src/screens/TaskJournalScreen.tsx)

**確認手順**:
1. アプリを起動
2. 「📝 タスク」タブをタップ
3. 以下が表示されることを確認:
   - 「完了: 0 / 0 (0%)」の進捗表示
   - 「新しいタスクを入力...」の入力欄
   - 「追加」ボタン
   - 「タスクがありません」の空白状態

**テスト手順**:
```
1. 入力欄に「買い物に行く」を入力
2. 「追加」ボタンをタップ
   → タスクが一覧に追加される

3. もう1つ「レポート提出」を追加
   → 2つ目のタスクが追加される

4. 「買い物に行く」のチェックボックスをタップ
   → 感情選択モーダルが表示される

5. 「😊 嬉しい」をタップ
   → タスクがグレーアウト、😊が表示される
   → 進捗が「完了: 1 / 2 (50%)」に更新される

6. 完了したタスクのチェックボックスをもう一度タップ
   → 未完了に戻る

7. 「レポート提出」の🗑️ボタンをタップ
   → 削除確認ダイアログ表示
   → 「削除」をタップでタスクが削除される
```

---

#### タスク2: 感情選択モーダルの動作確認

**ファイル**: [src/components/EmotionPicker.tsx](../src/components/EmotionPicker.tsx)

**確認内容**:
- ✅ タスク完了時にモーダルが表示される
- ✅ 6種類の絵文字が3列2行で表示される
- ✅ 各絵文字をタップすると選択される
- ✅ 選択後、モーダルが自動で閉じる
- ✅ キャンセルボタンで閉じることができる
- ✅ 背景をタップしても閉じる

**感情の種類**:
| 絵文字 | ラベル |
|-------|--------|
| 😊 | 嬉しい |
| 😌 | 満足 |
| 😫 | 疲れた |
| 😡 | イライラ |
| 😭 | 辛い |
| 😴 | 眠い |

---

#### タスク3: データベース連携の確認

**デバッグ方法**:
```typescript
// TaskJournalScreen.tsx の loadTasks 関数内
console.log(`✅ Loaded ${todayTasks.length} tasks for ${today}`);

// handleAddTask 関数内
console.log('✅ Task added:', trimmedText);

// handleEmotionSelect 関数内
console.log(`✅ Task ${selectedTaskId} completed with emotion: ${emotion}`);
```

**データベース直接確認**（開発時のみ）:
```typescript
// App.tsx に一時的に追加
import { debugDatabase } from './src/services/database';

useEffect(() => {
  const init = async () => {
    await openDatabase();
    await debugDatabase(); // ← これを追加
  };
  init();
}, []);
```

---

### Week 4のタスク（予定）

- [ ] キャラクター表情変化実装（HomeScreen.tsx修正）
- [ ] ホーム画面背景変化実装（HomeScreen.tsx修正）
- [ ] タスク一覧のフィルタ機能（完了/未完了切り替え）

---

## 🤝 共同作業タスク

### 統合テスト（Week 4 終わり）

**シナリオ1: 睡眠記録 → スコア表示の一連の流れ**
```
1. 睡眠記録画面で記録を入力・保存
2. ホーム画面に戻る
3. 保存したスコアが表示されることを確認
4. スリーピンの表情がスコアに応じて変化することを確認（Week 5）
```

**シナリオ2: タスク完了 → 感情記録の一連の流れ**
```
1. タスク管理画面でタスクを3つ追加
2. 1つ目を完了 → 😊（嬉しい）を選択
3. 2つ目を完了 → 😫（疲れた）を選択
4. タスク一覧で感情が表示されることを確認
5. 完了タスクがグレーアウトされることを確認
```

**シナリオ3: データの永続化確認**
```
1. 睡眠記録とタスクを保存
2. アプリを終了（完全終了）
3. アプリを再起動
4. データが残っていることを確認
```

---

## 🐛 よくあるエラーと対処法

### エラー1: `Cannot find module 'expo-sqlite'`

**原因**: 依存関係がインストールされていない

**対処法**:
```bash
npm install expo-sqlite --legacy-peer-deps
npm start
```

---

### エラー2: `Database is not initialized`

**原因**: App.tsx でデータベース初期化が実行されていない

**対処法**:
1. App.tsx に `openDatabase()` の useEffect が追加されているか確認
2. コンソールに「✅ App initialized with database」が表示されているか確認
3. 表示されない場合、アプリを再起動

---

### エラー3: `Text strings must be rendered within a <Text> component`

**原因**: React Nativeで `<span>` タグを使用している

**対処法**: すべての `<span>` を `<Text>` に変更（既に修正済み）

---

### エラー4: タスクが追加されない

**デバッグ手順**:
```typescript
// TaskJournalScreen.tsx の handleAddTask に追加
console.log('1. Input text:', newTaskText);
console.log('2. Trimmed text:', trimmedText);
console.log('3. Validation passed');
// await addTask() の後
console.log('4. Task added to database');
// await loadTasks() の後
console.log('5. Tasks reloaded:', tasks.length);
```

---

### エラー5: 睡眠スコアが表示されない

**デバッグ手順**:
```typescript
// SleepTrackerScreen.tsx の handleSave に追加
console.log('Score result:', scoreResult);

// HomeScreen.tsx の loadTodayScore に追加
console.log('Today:', today);
console.log('Record:', record);
console.log('Score:', record?.score);
```

---

## 📚 参考資料

### TypeScript型定義

すべての型は [src/types/database.ts](../src/types/database.ts) に定義済み:
- `SleepRecord`: 睡眠記録
- `Task`: タスク
- `DailyMission`: 睡眠改善課題

### データベーススキーマ

詳細は [002-requirements_definition_v0.1.md セクション5](./002-requirements_definition_v0.1.md) 参照

### 睡眠スコアアルゴリズム

詳細は [002-requirements_definition_v0.1.md セクション4](./002-requirements_definition_v0.1.md) 参照

### React Navigation ドキュメント

https://reactnavigation.org/docs/getting-started

### Expo SQLite ドキュメント

https://docs.expo.dev/versions/latest/sdk/sqlite/

---

## 💬 質問・サポート

### 技術的な質問
- **React Native実装**: 立川さん
- **設計・仕様**: 増田さん
- **UI/UX**: 藤川さん

### AI活用
- **ChatGPT/Claude**: コード生成、デバッグ支援
- 質問例: 「この関数のエラーを修正してください」「この機能を実装するコードを教えて」

---

## ✅ Week 3 完了チェックリスト

### 増田さん
- [ ] 睡眠記録画面が動作する
- [ ] 睡眠スコアが正しく計算される
- [ ] ホーム画面にスコアが表示される
- [ ] データベースに保存される
- [ ] 統合テストシナリオ1が成功する

### 藤川さん
- [ ] タスク管理画面が動作する
- [ ] タスクの追加・削除ができる
- [ ] 感情選択モーダルが表示される
- [ ] タスク完了で感情が記録される
- [ ] 統合テストシナリオ2が成功する

### 共通
- [ ] アプリが正常に起動する
- [ ] タブナビゲーションが動作する
- [ ] データベースが初期化される
- [ ] データが永続化される（再起動後も残る）

---

**作成者**: Claude AI
**最終更新**: 2025年10月30日

頑張ってください！困ったことがあればいつでも質問してください。
