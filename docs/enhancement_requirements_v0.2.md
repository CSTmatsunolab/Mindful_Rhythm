# 機能拡張要件定義書 v0.2

**作成日**: 2025年10月30日
**バージョン**: 0.2
**ステータス**: 設計中

---

## 📋 概要

Week 3-4で実装された基本機能に対して、ユーザーからの要望に基づく機能拡張を定義します。

---

## 🎯 拡張要件

### 1. 睡眠記録機能の改善

#### 1.1 任意の日付での登録

**現状の問題**:
- 睡眠記録が今日の日付固定になっている
- 過去の記録を遡って追加できない

**改善要件**:
- ユーザーが任意の日付を選択できる
- 過去7日分までの記録を追加可能
- 日付選択用のDateTimePickerを実装

**実装箇所**:
- `src/screens/SleepTrackerScreen.tsx`
- データベーススキーマは変更不要（dateフィールド既存）

**UI設計**:
```
┌─────────────────────────────┐
│  📅 記録日を選択             │
│  ┌───────────────────────┐  │
│  │  2025年10月28日 (月)   │  │  ← タップで日付選択
│  └───────────────────────┘  │
│                             │
│  就寝時刻: 23:00            │
│  起床時刻: 07:00            │
│  ...                        │
└─────────────────────────────┘
```

**優先度**: 高
**担当**: 増田さん
**想定工数**: 1-2時間

---

### 2. タスク管理機能の拡張

#### 2.1 締め切り日の設定

**要件**:
- 各タスクに締め切り日（deadline）を設定可能
- 締め切り日が近いタスクは強調表示
- 締め切り日が過ぎたタスクは警告表示

**データベーススキーマ変更**:
```sql
ALTER TABLE tasks ADD COLUMN deadline TEXT; -- YYYY-MM-DD形式
```

**UI設計**:
```
┌─────────────────────────────┐
│  新しいタスク                │
│  ┌───────────────────────┐  │
│  │  タスク名を入力        │  │
│  └───────────────────────┘  │
│                             │
│  📅 締め切り: 2025年10月31日 │  ← 新規追加
│                             │
│  ⚡ 難易度: ●●●○○          │  ← 新規追加
└─────────────────────────────┘
```

**表示ルール**:
- 締め切り当日: 🔴 赤色強調
- 締め切り3日前: 🟡 黄色警告
- 締め切り1週間前: 🟢 通常表示

**優先度**: 高
**担当**: 藤川さん
**想定工数**: 2-3時間

---

#### 2.2 タスクの難易度（負荷度）設定

**要件**:
- タスクの難易度を5段階（1〜5）で設定
- 難易度は視覚的に表示（星マークまたはバー）
- 1日の合計負荷度を計算

**データベーススキーマ変更**:
```sql
ALTER TABLE tasks ADD COLUMN difficulty INTEGER DEFAULT 3; -- 1-5の範囲
```

**難易度の定義**:
| レベル | 表示 | 説明 | 想定作業時間 |
|--------|------|------|-------------|
| 1 | ⚡ | 簡単 | 15分未満 |
| 2 | ⚡⚡ | やや簡単 | 15-30分 |
| 3 | ⚡⚡⚡ | 普通 | 30-60分 |
| 4 | ⚡⚡⚡⚡ | やや難しい | 1-2時間 |
| 5 | ⚡⚡⚡⚡⚡ | 難しい | 2時間以上 |

**優先度**: 高
**担当**: 藤川さん
**想定工数**: 2-3時間

---

### 3. 睡眠分析・警告機能（ホーム画面）

#### 3.1 睡眠パターン分析

**要件**:
- 過去7日間の睡眠時間の平均を計算
- 過去7日間の睡眠スコアの平均を計算
- 睡眠トレンド（改善/悪化）を判定

**分析ロジック**:
```typescript
interface SleepAnalysis {
  averageSleepHours: number;      // 平均睡眠時間
  averageSleepScore: number;      // 平均スコア
  trend: 'improving' | 'stable' | 'declining';  // トレンド
  recommendation: string;          // 推奨メッセージ
}
```

**実装箇所**:
- `src/services/sleepAnalyzer.ts`（新規作成）

**優先度**: 中
**担当**: 増田さん
**想定工数**: 2-3時間

---

#### 3.2 タスク負荷度分析

**要件**:
- 今日のタスクの合計難易度を計算
- 明日のタスクの合計難易度を計算
- 高負荷日には早寝を推奨

**負荷度判定ロジック**:
```typescript
interface TaskLoadAnalysis {
  todayLoad: number;              // 今日の負荷度合計
  tomorrowLoad: number;           // 明日の負荷度合計
  isHighLoad: boolean;            // 高負荷フラグ
  recommendedSleepTime: string;   // 推奨就寝時刻
}
```

**高負荷の定義**:
- 合計負荷度 ≥ 15: 高負荷（2時間早く寝る推奨）
- 合計負荷度 10-14: 中負荷（1時間早く寝る推奨）
- 合計負荷度 < 10: 通常負荷

**実装箇所**:
- `src/services/taskAnalyzer.ts`（新規作成）

**優先度**: 中
**担当**: 藤川さん
**想定工数**: 2-3時間

---

#### 3.3 統合的な睡眠推奨機能

**要件**:
- 睡眠分析 + タスク負荷度分析を統合
- 総合的な警告メッセージを表示
- ホーム画面の上部に警告バナーを表示

**警告パターン**:

| 条件 | 警告レベル | メッセージ |
|------|-----------|-----------|
| 睡眠不足 + 明日高負荷 | 🔴 緊急 | 明日は大変な1日です。今日は22:00までに就寝しましょう！ |
| 睡眠不足 + 明日中負荷 | 🟡 警告 | 睡眠不足が続いています。今日は早めに休みましょう。 |
| 睡眠十分 + 明日高負荷 | 🟢 注意 | 明日は忙しい1日になります。今日はしっかり休息を。 |
| 睡眠不足 + 明日通常 | 🟡 警告 | 睡眠不足が続いています。今日は体を休めましょう。 |
| 睡眠十分 + 明日通常 | ✅ 良好 | 良好な睡眠が続いています！この調子で！ |

**UI設計**:
```
┌─────────────────────────────┐
│  🏠 ホーム画面               │
│                             │
│  ┌─────────────────────┐    │
│  │ 🔴 睡眠推奨アラート    │    │
│  │ 明日は大変な1日です。  │    │
│  │ 今日は22:00までに     │    │
│  │ 就寝しましょう！       │    │
│  └─────────────────────┘    │
│                             │
│  😫 スリーピン              │
│  睡眠スコア: 55点           │
│  ...                        │
└─────────────────────────────┘
```

**実装箇所**:
- `src/components/SleepRecommendationBanner.tsx`（新規作成）
- `src/services/recommendationEngine.ts`（新規作成）
- `src/screens/HomeScreen.tsx`（修正）

**優先度**: 高
**担当**: 増田さん・藤川さん（共同）
**想定工数**: 3-4時間

---

## 📊 実装優先順位

### Week 4（残り20%）
1. **任意の日付での睡眠記録** ⭐⭐⭐ 緊急
2. **タスクの締め切り日設定** ⭐⭐⭐ 緊急
3. **タスクの難易度設定** ⭐⭐⭐ 緊急

### Week 5-6（拡張機能）
4. **睡眠パターン分析** ⭐⭐ 重要
5. **タスク負荷度分析** ⭐⭐ 重要
6. **統合的な睡眠推奨機能** ⭐⭐⭐ 重要

---

## 🗃️ データベーススキーマ変更

### tasksテーブルへの追加

```sql
-- 既存テーブル
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  date TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',
  emotion TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- 追加カラム
ALTER TABLE tasks ADD COLUMN deadline TEXT;        -- 締め切り日（YYYY-MM-DD）
ALTER TABLE tasks ADD COLUMN difficulty INTEGER DEFAULT 3;  -- 難易度（1-5）
```

### 型定義の更新

```typescript
// src/types/database.ts

export interface Task {
  id: number;
  title: string;
  date: string;
  status: 'pending' | 'done';
  emotion: string | null;
  deadline: string | null;      // 新規追加
  difficulty: number;            // 新規追加（1-5）
  created_at: string;
  updated_at: string;
}
```

---

## 🧪 テスト計画

### 1. 日付選択機能のテスト
- [ ] 過去7日分の日付を選択できる
- [ ] 未来の日付は選択できない（エラー表示）
- [ ] 同じ日付で重複登録できない（上書き確認）

### 2. 締め切り日機能のテスト
- [ ] 締め切り日を設定できる
- [ ] 締め切り日が近いタスクが強調表示される
- [ ] 締め切り日を過ぎたタスクが警告表示される

### 3. 難易度機能のテスト
- [ ] 難易度を1-5で設定できる
- [ ] 1日の合計負荷度が計算される
- [ ] 負荷度に応じて表示が変わる

### 4. 分析・警告機能のテスト
- [ ] 過去7日間の睡眠データが正しく分析される
- [ ] 明日のタスク負荷度が正しく計算される
- [ ] 適切な警告メッセージが表示される
- [ ] 警告バナーがタップで詳細表示される

---

## 📈 期待される効果

### ユーザビリティ向上
- 記録忘れを遡って追加できる（利便性向上）
- タスク管理がより実用的になる（締め切り・難易度）
- 睡眠改善のための具体的なアドバイスが得られる

### 研究価値
- タスク負荷度と睡眠の関係性を分析できる
- 予測的な睡眠推奨の有効性を検証できる
- ユーザー行動変容のデータが取得できる

---

## 🚨 リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| スキーマ変更によるデータ移行 | 中 | マイグレーションスクリプト作成 |
| 分析ロジックの複雑化 | 中 | 段階的実装、ユニットテスト充実 |
| UI の複雑化 | 低 | シンプルなデザイン優先 |
| パフォーマンス低下 | 低 | 分析処理のキャッシング |

---

## 📚 参考資料

- CBT-I理論（認知行動療法）
- タスク管理のベストプラクティス
- 睡眠推奨システムの先行研究

---

**次のステップ**: 各機能の詳細設計と実装タスクリストの作成
